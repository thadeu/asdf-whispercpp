#!/usr/bin/env bash
set -euo pipefail

install_whisper() {
    # Cria o diretório temporário
    TMP_DIR=$(mktemp -d -t whispercpp-XXXX)
    echo ">>> Criando diretório temporário: $TMP_DIR"

    # Garantir que ele será apagado mesmo se houver erro
    cleanup() {
        if [[ -d "$TMP_DIR" ]]; then
            echo ">>> Removendo diretório temporário: $TMP_DIR"
            rm -rf "$TMP_DIR"
        fi
    }
    trap cleanup EXIT

    # Clona e compila
    git clone https://github.com/ggerganov/whisper.cpp.git "$TMP_DIR"
    cd "$TMP_DIR"
    mkdir -p build && cd build
    cmake ..
    cmake --build . --config Release

    # Copia o binário para o destino
    INSTALL_PATH="$1"
    mkdir -p "$INSTALL_PATH/bin"
    cp whisper-cli "$INSTALL_PATH/bin/whisper"

    echo ">>> Whisper instalado em $INSTALL_PATH"
}

# Usa a função
install_whisper "$1"
