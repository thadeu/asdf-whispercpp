#!/usr/bin/env bash
set -euo pipefail

# Caminho para o whisper original
WHISPER_CLI="$(dirname "$0")/whisper-cli"

# Pasta onde os models serão armazenados
MODEL_DIR="${HOME}/.local/share/mise/whisper-models"
mkdir -p "$MODEL_DIR"

# Função para baixar o modelo
download_model() {
    local model_name="$1"
    echo "Baixando modelo $model_name..."
    curl -L -o "${MODEL_DIR}/ggml-${model_name}.bin" \
        "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/models/ggml-${model_name}.bin"
}

# Array para armazenar argumentos do whisper
ARGS=()

# Loop para processar parâmetros
while [[ $# -gt 0 ]]; do
    case "$1" in
        -m|--model)
            if [[ $# -lt 2 ]]; then
                echo "ERRO: '-m|--model' requer um argumento"
                exit 1
            fi

            MODEL="$2"
            # Substitui o argumento pelo caminho do modelo baixado
            MODEL_PATH="${MODEL_DIR}/ggml-${MODEL}.bin"
            if [[ ! -f "$MODEL_PATH" ]]; then
                download_model "$MODEL"
            else
                echo "Modelo $MODEL já existe. Usando $MODEL_PATH"
            fi
            ARGS+=("--model" "$MODEL_PATH")
            shift 2
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done

# Executa o whisper original com todos os argumentos
"$WHISPER_CLI" "${ARGS[@]}"
